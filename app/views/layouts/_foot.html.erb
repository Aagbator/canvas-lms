<script>
  INST = <%= raw(inst_env.to_json) %>;
  ENV = <%= raw Api.recursively_stringify_json_ids(js_env.clone).to_json %>;

  // TODO: move this out when we have a single require call
  require = {
    translate: <%= include_js_translations? %>,
    baseUrl: '<%= js_base_url %>',
    paths: <%= raw Canvas::RequireJs.paths(true) %>,
    packages : <%= raw Canvas::RequireJs.packages %>,
    shim: <%= raw Canvas::RequireJs.shims %>,
    map: <%= raw Canvas::RequireJs.map %>,
    waitSeconds: 60
  };
</script>

<%= javascript_include_tag "#{js_base_url}/vendor/require.js" %>
<%= javascript_include_tag "#{js_base_url}/compiled/bundles/common" if include_common_bundle %>
<%= include_js_bundles %>
<%= include_account_js %>
<%= render_js_blocks %>
<%= render_hidden_dialogs %>

<script>
// Determines if the scripts are loaded.
// When we get everything out of the views, and have a single top-level
// `require`, this becomes meaningless and will be abandoned.
(function() {
  var attempts = 0;
  var timeout = 10;
  var check = function() {
    attempts++;
    var done = !window.requirejs.s.contexts._.defQueue.length
    var giveup = attempts === 100; // 1 second
    if (done || giveup) {
      var className = document.documentElement.className;
      document.documentElement.className = className.replace(/scripts-not-loaded/, '');
      return;
    }
    setTimeout(check, timeout);
  };

  check();
}).call(this);
</script>

<div id="bz-tz-warning" style="display: none;">
  We noticed that your current timezone doesn't match your <a href="/profile/settings">settings</a>.
  <br />
  Consider changing your <a href="/profile/settings">settings</a> so your due dates show the right time!
  <br />
  <button type="button" onclick="localStorage.skipTzWarning = 'yes'; this.parentNode.style.display = 'none';">Don't tell me again</button>
</div>

<script>
  if(ENV["TIMEZONE_OFFSET"] && localStorage.skipTzWarning != "yes") {
    // JS gives minutes, Rails gives seconds, and they come from other directions
    // so the negative and divide make them match up
    var rails_tz = -ENV["TIMEZONE_OFFSET"] / 60;
    var offset = new Date().getTimezoneOffset();
    if(rails_tz != offset) {
      var t = document.getElementById("bz-tz-warning");
      if(t)
        t.style.display = "";
    }
  }
</script>
